(function(O){"use strict";var S={csrfToken:O("meta[name=csrf-token]").attr("content"),csrfTokenName:O("meta[name=csrf-param]").attr("content"),nameLabel:"Name",descriptionLabel:"Description",deleteConfirmation:"Images will be permanently deleted. Are you sure?",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",enableUrl:"",disableUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function a(e,a){var r=O.extend({},S,a);var t=r.csrfToken?"&"+r.csrfTokenName+"="+r.csrfToken:"";var c={};var l=O(e);if(!r.hasName){if(!r.hasDesc){l.addClass("no-name-no-desc");O(".edit_selected",l).hide()}else l.addClass("no-name")}else if(!r.hasDesc)l.addClass("no-desc");var s=O(".sorter",l);var d=O(".images",s);var h=O(".gallery-editor-modal");var p=O(".progress-overlay",l);var f=O(".upload-progress",p);var u=O(".form",h);function o(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function v(e,a,t,s){var n='<div class="photo-editor row">'+'<div class="col-xs-4">'+'<img src="'+o(a)+'"  style="max-width:100%;">'+"</div>"+'<div class="col-xs-8">'+(r.hasName?'<div class="form-group">'+'<label class="control-label" for="photo_name_'+e+'">'+r.nameLabel+":</label>"+'<input class="form-control" type="text" name="photo['+e+'][name]" class="input-xlarge" value="'+o(t)+'" id="photo_name_'+e+'"/>'+"</div>":"")+(r.hasDesc?'<div class="form-group">'+'<label class="control-label" for="photo_description_'+e+'">'+r.descriptionLabel+":</label>"+'<textarea class="form-control" name="photo['+e+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+e+'">'+o(s)+"</textarea>"+"</div>":"")+"</div>"+"</div>";return O(n)}var m='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(r.hasName){m+="<h5></h5>"}if(r.hasDesc){m+="<p></p>"}m+='</div><div class="actions">';m+='<span class="enablePhoto btn btn-warning btn-xs"><i class="glyphicon glyphicon-eye-close glyphicon-white"></i></span> ';m+='<span class="disablePhoto btn btn-success btn-xs"><i class="glyphicon glyphicon-eye-open glyphicon-white"></i></span> ';if(r.hasName||r.hasDesc){m+='<span class="editPhoto btn btn-primary btn-xs"><i class="glyphicon glyphicon-pencil glyphicon-white"></i></span> '}m+='<span class="deletePhoto btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';function g(e,a,t,s,n,o){var i=O(m);c[e]=i;i.data("id",e);i.data("rank",n);i.data("status",o);O("img",i).attr("src",a);if(r.hasName){O(".caption h5",i).text(t)}if(r.hasDesc){O(".caption p",i).text(s)}if(o==0){O(".disablePhoto",i).hide()}else{O(".enablePhoto",i).hide()}d.append(i);return i}function b(e){var a=e.length;var t=u.empty();for(var s=0;s<a;s++){var n=e[s];var o=c[n],i=O("img",o).attr("src"),r=O(".caption h5",o).text(),l=O(".caption p",o).text();t.append(v(n,i,r,l))}if(a>0){h.modal("show")}}function n(s){O.ajax({type:"POST",url:r.deleteUrl,data:"id[]="+s.join("&id[]=")+t,success:function(e){if(e=="OK"){for(var a=0,t=s.length;a<t;a++){c[s[a]].remove();delete c[s[a]]}}else{alert(e)}}})}function i(a){O.ajax({type:"POST",url:r.enableUrl,data:"id[]="+a.join("&id[]=")+t,success:function(e){if(e=="OK"){O.each(a,function(e,a){var t=c[a];O(".enablePhoto",t).hide();O(".disablePhoto",t).show()})}else{alert(e)}}})}function k(a){O.ajax({type:"POST",url:r.disableUrl,data:"id[]="+a.join("&id[]=")+t,success:function(e){if(e=="OK"){O.each(a,function(e,a){var t=c[a];O(".enablePhoto",t).show();O(".disablePhoto",t).hide()})}else{alert(e)}}})}function y(e){e.preventDefault();var a=O(this).closest(".photo");var t=a.data("id");i([t]);return false}function w(e){e.preventDefault();var a=O(this).closest(".photo");var t=a.data("id");k([t]);return false}function D(e){e.preventDefault();var a=O(this).closest(".photo");var t=a.data("id");if(!confirm(r.deleteConfirmation))return false;n([t]);return false}function x(e){e.preventDefault();var a=O(this).closest(".photo");var t=a.data("id");b([t]);return false}function _(){var e=O(".photo.selected",s).length;O(".select_all",l).prop("checked",O(".photo",s).length==e);if(e==0){O(".edit_selected, .remove_selected, .enable_selected, .disable_selected",l).addClass("disabled")}else{O(".edit_selected, .remove_selected, .enable_selected, .disable_selected",l).removeClass("disabled")}}function P(){var e=O(this);if(e.is(":checked"))e.closest(".photo").addClass("selected");else e.closest(".photo").removeClass("selected");_()}function T(){O(".photo.selected",s).each(function(){O(".photo-select",this).prop("checked",false)}).removeClass("selected");O(".select_all",l).prop("checked",false);_()}d.on("click",".photo .enablePhoto",y).on("click",".photo .disablePhoto",w).on("click",".photo .deletePhoto",D).on("click",".photo .editPhoto",x).on("click",".photo .photo-select",P);O(".images",s).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var a=[];O(".photo",s).each(function(){var e=O(this);a.push("order["+e.data("id")+"]="+e.data("rank"))});O.ajax({type:"POST",url:r.arrangeUrl,data:a.join("&")+t,dataType:"json"}).done(function(e){for(var a in e[a]){c[a].data("rank",e[a])}})});if(window.FormData!==undefined){var N=O(".afile",l).attr("name");var j=function(e){if(e.length==0)return;p.show();f.css("width","5%");var a=e.length;var t=0;var s=[];for(var n=0;n<a;n++){var o=new FormData;o.append(N,e[n]);if(r.csrfToken){o.append(r.csrfTokenName,r.csrfToken)}var i=new XMLHttpRequest;i.open("POST",r.uploadUrl,true);i.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);g(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["status"]);s.push(e["id"])}else{}f.css("width",""+(5+95*t/a)+"%");if(t===a){f.css("width","100%");p.hide();if(r.hasName||r.hasDesc)b(s)}};i.send(o)}};(function(){var e=l[0];var t=false;var a=false;setInterval(function(){if(t!=a){if(t)e.classList.add("over");else e.classList.remove("over");a=t}},30);function s(e){e.preventDefault();t=true;return false}function n(){t=false;return false}function o(e){e.preventDefault();e.stopPropagation();var a=e.dataTransfer.files;j(a);t=false;return false}function i(){t=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",n,false);e.addEventListener("drop",o,false);e.addEventListener("dragend",i,false)})();O(".afile",l).attr("multiple","true").on("change",function(e){e.preventDefault();j(this.files);O(this).val(null)})}else{O(".afile",l).on("change",function(e){e.preventDefault();var a=[];p.show();f.css("width","5%");var t={};if(r.csrfToken)t[r.csrfTokenName]=r.csrfToken;O.ajax({type:"POST",url:r.uploadUrl,data:t,files:O(this),iframe:true,processData:false,dataType:"json"}).done(function(e){g(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["status"]);a.push(e["id"]);f.css("width","100%");p.hide();if(r.hasName||r.hasDesc)b(a)})})}O(".save-changes",h).click(function(e){e.preventDefault();O.post(r.updateUrl,O("input, textarea",u).serialize()+t,function(e){var a=e.length;for(var t=0;t<a;t++){var s=e[t];var n=c[s.id];O("img",n).attr("src",s["src"]);if(r.hasName)O(".caption h5",n).text(s["name"]);if(r.hasDesc)O(".caption p",n).text(s["description"])}h.modal("hide");T()},"json")});O(".enable_selected",l).click(function(e){e.preventDefault();var a=[];O(".photo.selected",s).each(function(){a.push(O(this).data("id"))});i(a);return false});O(".disable_selected",l).click(function(e){e.preventDefault();var a=[];O(".photo.selected",s).each(function(){a.push(O(this).data("id"))});k(a);return false});O(".edit_selected",l).click(function(e){e.preventDefault();var a=[];O(".photo.selected",s).each(function(){a.push(O(this).data("id"))});b(a);return false});O(".remove_selected",l).click(function(e){e.preventDefault();if(!confirm(r.deleteConfirmation))return false;var a=[];O(".photo.selected",s).each(function(){a.push(O(this).data("id"))});n(a)});O(".select_all",l).change(function(){if(O(this).prop("checked")){O(".photo",s).each(function(){O(".photo-select",this).prop("checked",true)}).addClass("selected")}else{O(".photo.selected",s).each(function(){O(".photo-select",this).prop("checked",false)}).removeClass("selected")}_()});for(var C=0,U=r.photos.length;C<U;C++){var L=r.photos[C];g(L["id"],L["preview"],L["name"],L["description"],L["rank"],L["status"])}}O.fn.galleryManager=function(e){if(this.length){this.each(function(){a(this,e)})}}})(jQuery);